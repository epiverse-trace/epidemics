<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Design principles for epidemics • epidemics</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Design principles for epidemics">
<meta name="robots" content="noindex">
<!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZ471458FQ"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XZ471458FQ');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">
    <a href="https://epiverse-trace.github.io/" class="external-link"><img src="https://epiverse-trace.github.io/blueprints/logo_white.svg" id="logo" alt="Epiverse-TRACE"></a>
    <a class="navbar-brand me-2" href="../index.html">epidemics</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.4.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epidemics.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modelling interventions</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_interventions.html">Getting started with modelling interventions targeting social contacts</a></li>
    <li><a class="dropdown-item" href="../articles/modelling_multiple_interventions.html">Modelling overlapping and sequential interventions targeting social contacts</a></li>
    <li><a class="dropdown-item" href="../articles/modelling_rate_interventions.html">Modelling interventions that change infection parameters</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modelling vaccination</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_vaccination.html">Modelling the effect of a vaccination campaign</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modelling seasonality</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_time_dependence.html">Modelling time-dependence and seasonality in transmission dynamics</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Run models with multiple populations</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_populations.html">Modelling in multiple populations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced modelling</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_param_uncertainty.html">Modelling parameter uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/modelling_scenarios.html">Modelling intervention scenarios</a></li>
    <li><a class="dropdown-item" href="../articles/finalsize_comparison.html">Reducing parameters required for final size estimation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides to library models</h6></li>
    <li><a class="dropdown-item" href="../articles/model_vacamole.html">Modelling leaky vaccination and hospitalisation outcomes with Vacamole</a></li>
    <li><a class="dropdown-item" href="../articles/model_ebola.html">Modelling responses to a stochastic Ebola virus epidemic</a></li>
    <li><a class="dropdown-item" href="../articles/model_diphtheria.html">Modelling a diphtheria outbreak in a humanitarian camp setting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides for developers</h6></li>
    <li><a class="dropdown-item" href="../articles/design-principles.html">Design principles for epidemics</a></li>
    <li><a class="dropdown-item" href="../articles/developer-walkthrough.html">Guide to developing epidemics features</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epiverse-trace/epidemics/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Design principles for epidemics</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epiverse-trace/epidemics/blob/main/vignettes/design-principles.Rmd" class="external-link"><code>vignettes/design-principles.Rmd</code></a></small>
      <div class="d-none name"><code>design-principles.Rmd</code></div>
    </div>

    
    
<p>This vignette outlines the design decisions that have been taken
during the development of the <em>epidemics</em> R package, and provides
some of the reasoning, and possible pros and cons of each decision.</p>
<p>This document is primarily intended to be read by those interested in
understanding the code within the package and for potential package
contributors.</p>
<div class="section level2">
<h2 id="scope">Scope<a class="anchor" aria-label="anchor" href="#scope"></a>
</h2>
<p><em>epidemics</em> aims to help public health practitioners - rather
than research-focussed modellers - to rapidly simulate disease outbreak
scenarios, and aims to <strong>balance flexibility, performance,
user-friendliness, and maintainability</strong>.</p>
<ul>
<li><p><em>epidemics</em> trades away some flexibility in defining model
structures for a gain in the ease of defining epidemic scenario
components such as affected populations and model events.</p></li>
<li><p><em>epidemics</em> attempts to balance performance and
maintainability through minimum sufficient use of C++, and not
attempting to write a domain-specific language (such as <a href="https://cran.r-project.org/package=odin" class="external-link"><em>odin</em></a>).</p></li>
<li><p>To be more broadly applicable, <em>epidemics</em> provides a
‘library’ of compartmental models which are adapted from the published
literature. These models focus on broad types of diseases or settings,
rather than specific diseases or scenarios. Thus all models are intended
to be applicable to a range of diseases.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="output">Output<a class="anchor" aria-label="anchor" href="#output"></a>
</h2>
<p>All function outputs are expected to return a structure that inherits
from <code>&lt;data.frame&gt;</code>, to make further processing easier
for users. The exact structure of the output - whether a list of
<code>&lt;data.frame&gt;</code>s, a <code>&lt;data.table&gt;</code> or
<code>&lt;tibble&gt;</code>, or a nested version of these tabular data
classes - is yet to be fixed. The eventual stable output type must allow
users to conveniently access the epidemic trajectory data, identify and
filter intervention scenarios for comparisons among them, and allow
interoperability with data science tools such as the <a href="https://www.tidyverse.org/" class="external-link">Tidyverse</a>.</p>
</div>
<div class="section level2">
<h2 id="package-architecture">Package architecture<a class="anchor" aria-label="anchor" href="#package-architecture"></a>
</h2>
<p><img src="../reference/figures/epidemics_design.png" width="700"></p>
<p><strong>Fig. 1:</strong> <em>epidemics</em> is designed to allow easy
combination of composable elements with a model structure taken from a
library of published models, with sensible default parameters, to allow
public health practitioners to conveniently model epidemic scenarios and
the efficacy of response strategies.</p>
<p><img src="../reference/figures/epidemics_architecture.png" width="900"></p>
<p><strong>Fig. 2:</strong> <em>epidemics</em> package architecture, and
the ODE model stack. <em>epidemics</em> includes multiple internal
functions in both R and C++ which check that inputs are suitable for
each model, and to cross-check that inputs are compatible with each
other. Function names indicate their behaviour
(e.g. <code>assert_*()</code>), but not all similarly named functions
are called at similar places in model function bodies. Partly, this
reflects the privileged positions of some model components (such as the
<code>population</code>, against which other components are checked),
but also that some composable elements (such as time-dependence) may not
be vectorised.</p>
</div>
<div class="section level2">
<h2 id="design-decisions">Design decisions<a class="anchor" aria-label="anchor" href="#design-decisions"></a>
</h2>
<div class="section level3">
<h3 id="epidemic-modelling">Epidemic modelling<a class="anchor" aria-label="anchor" href="#epidemic-modelling"></a>
</h3>
<p>The notes here refer to broad decisions and not to individual models
– see individual model vignettes and published sources for modelling
decisions.</p>
<ul>
<li>
<p>There are two broad types of models:</p>
<ul>
<li><p>Deterministic models implemented as solutions to systems of
ordinary different equations (ODEs),</p></li>
<li><p>Stochastic models with discrete timesteps where individuals move
between compartments probabilistically.</p></li>
</ul>
</li>
<li><p><em>epidemics</em> models’ compartmental transitions are fixed.
Users cannot create new links between compartments, although links
between compartments can be disallowed by modifying model
parameters.</p></li>
<li><p>The models’ epidemiological parameter sets are unique, although
some parameters are shared among models. These can be changed by users
although reasonable default values are provided.</p></li>
<li><p>The model components - such as the population affected by the
epidemic, or any policy responses in the form of interventions - are
called <strong>composable elements</strong>. Composable elements can be
and are expected to be modified by users to match their situation. All
model components except the <code>population</code> are
optional.</p></li>
<li><p>Each model allows a unique sets of composable elements considered
suitable for the expected use case. E.g. the Ebola model does not allow
modelling a vaccination regime, as this is considered unlikely for most
Ebola outbreaks. The allowed set of composable elements is subject to
change, and is open to user requests.</p></li>
<li><p>The <strong>effect of interventions is modelled as being
additive, not multiplicative</strong>. When an intervention with an X%
reduction in contacts overlaps with an intervention with a Y% reduction,
the cumulative effect on contacts
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>×</mo><mn>1</mn><mo>−</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>X</mi><mo>+</mo><mi>Y</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">C \times 1 - (X + Y)</annotation></semantics></math>,
rather than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>×</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>Y</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">C \times (1 - X)(1 - Y)</annotation></semantics></math>.
Additive effects were considered easier for users to understand than
multiplicative effects.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="ode-systems-and-models">ODE systems and models<a class="anchor" aria-label="anchor" href="#ode-systems-and-models"></a>
</h3>
<ul>
<li><p>A common method for defining and solving ODEs in R is to write
the ODE system in R and pass it to solvers such as
<code><a href="https://rdrr.io/pkg/deSolve/man/lsoda.html" class="external-link">deSolve::lsoda()</a></code> from the <a href="https://cran.r-project.org/package=deSolve" class="external-link"><em>deSolve</em>
package</a>. We have opted against this approach (referred to as
‘R-deSolve’).</p></li>
<li><p>It is possible to write ODE compartmental transitions in C++, and
expose the C++ code to R, eventually passing this ODE system to deSolve
solvers (referred to as ‘Rcpp-deSolve’). We have also opted against this
approach, as it involves substantial interconversion of more complex
objects such as structured lists (the model composable elements) from R
to C++ in each solver timestep, reducing performance.</p></li>
<li><p>ODE systems are written in C++, and solved using the <a href="https://www.boost.org/doc/libs/1_84_0/libs/numeric/odeint/doc/html/index.html" class="external-link">Boost
<em>odeint</em> solvers</a> with <em>fixed step sizes</em>. This means
that within each call to <code>model_*()</code>, R objects are converted
for use by C++ only once (in the scalar arguments case), and are not
passed back and forth multiple times.</p></li>
<li><p><em>odeint</em> is provided by the package <a href="https://cran.r-project.org/package=BH" class="external-link">BH (Boost Headers)</a>,
making it convenient to use in Rcpp packages. The <a href="https://cran.r-project.org/package=r2sundials" class="external-link"><em>r2sundials</em>
package</a> provides an Rcpp-friendly interface to the <a href="https://computing.llnl.gov/projects/sundials" class="external-link">SUNDIALS ODE
solvers</a>, but the documentation is less clear overall, and seems to
recommend the use of <a href="https://cran.r-project.org/package=RcppArmadillo" class="external-link"><em>RcppArmadillo</em></a>
and <a href="https://cran.r-project.org/package=RcppXPtrUtils" class="external-link"><em>RcppXPtrUtils</em></a>;
these have not been evaluated for use.</p></li>
<li><p><em>odeint</em> imposes certain constraints on ODE systems. There
is no functionality to easily define ‘events’ (also called ‘callbacks’)
and combine them with the ODE system. This means that the ODE systems
have to encapsulate information on the timing of events (such as
interventions) and the effect.</p></li>
<li><p>Equations describing <strong>the right-hand side of model ODE
systems</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>′</mi><mo>=</mo><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">x' = f(x)</annotation></semantics></math>
are thus written as <a href="https://cplusplus.com/doc/tutorial/structures/" class="external-link"><code>structs</code></a>
with an <a href="https://en.cppreference.com/w/cpp/language/operators" class="external-link">overloaded
function call operator</a> that makes them <a href="https://en.cppreference.com/w/cpp/named_req/FunctionObject" class="external-link"><code>FunctionObject</code>
types</a>. The <code>struct</code> thus holds epidemiological parameters
and composable elements, which are passed by reference in any
operations, reducing copying. <a href="https://live.boost.org/doc/libs/1_84_0/libs/numeric/odeint/doc/html/boost_numeric_odeint/getting_started/short_example.html" class="external-link">See
this simple example from the Boost documentation.</a> It can be passed
as a function to a solver, and the epidemiological parameters are
calculated in each solver timestep as <strong>some function of time and
the composable elements</strong> (as applicable).</p></li>
<li><p><em>epidemics</em> relies on the Eigen C++ library provided by
RcppEigen to represent matrices of initial conditions. Eigen matrices
are among the types accepted as initial states by <em>odeint</em>
solvers. Alternatives include Boost Basic Linear Algebra Library (uBLAS)
and standard library arrays and vectors; <a href="https://live.boost.org/doc/libs/1_84_0/libs/numeric/odeint/doc/html/boost_numeric_odeint/getting_started/overview.html" class="external-link">a
partial list - which does not include Eigen - is provided by Boost</a>,
and Armadillo matrices may also be supported. We use Eigen matrices as
Eigen offers broad and well documented support for matrix operations,
easy conversion between Rcpp types, and also conforms to previous use of
Eigen in <a href="https://cran.r-project.org/package=finalsize" class="external-link"><em>finalsize</em></a>.</p></li>
<li><p>The models’ C++ code is in two levels that underlie the R source
code - the C++ source code and the C++ headers. This is to make the
header code (the model ODEs and helper functions) shareable so that they
can be re-used in other Rcpp packages and <a href="https://epiverse-trace.github.io/posts/share-cpp/" class="external-link">this is
explored more in this blog post.</a></p></li>
<li><p><em>epidemics</em> defines C++ namespaces in the package headers
to more clearly indicate where certain functionalities sit. All model
structures are in the namespace <code>epidemics</code>, while the
namespaces <code>vaccination</code>, <code>intervention</code>, and
<code>time_dependence</code> contain C++ code to handle these composable
elements (such as calculating the effect of cumulative interventions).
The namespace <code>odetools</code> defines the initial state type,
which is an <code>Eigen::MatrixXd</code>.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="stochastic-models">Stochastic models<a class="anchor" aria-label="anchor" href="#stochastic-models"></a>
</h3>
<p><em>epidemics</em> currently includes a single discrete-time
stochastic model that implements a sub-compartment system taken from
<span class="citation">@getz2018</span>, and initially adapted in
<em>Epirecipes</em>. Some modelling decisions are explained here, while
recognising that adding more models with different implementations could
see them being revisited.</p>
<ul>
<li><p>Stochastic models currently target, and are expected to target,
diseases for which outbreak sizes are initially small and thus where
stochasticity matters more; the typical example is Ebola virus disease
(simply, Ebola), and this is reflected in the model name.</p></li>
<li><p>The Ebola model is also expected to be suitable for diseases with
a high fatality risk that are detected when outbreak sizes are small,
and with an isolation and treatment response comparable to Ebola,
e.g. Marburg virus disease.</p></li>
<li><p><strong>Note that</strong> very different alternative
implementations of stochastic models exist.</p></li>
<li><p>The current implementation was chosen due to the use of Erlang
sub-compartments that were felt to better represent the long-tailed
distributions of infection times seen in haemorrhagic fevers like
Ebola.</p></li>
<li><p>The model implements a two-level structure similar to the ODE
models, with <code><a href="../reference/dot-model_ebola_internal.html">.model_ebola_internal()</a></code> the function
implementing the simulation, while <code><a href="../reference/model_ebola.html">model_ebola()</a></code> is the
user-facing wrapper with input checks and parameter and scenario
combination handling.</p></li>
<li><p>The model allows vectors for the infection parameters and the
duration (called <code>time_end</code>); however the number of
replicates for each parameter-scenario combination is not allowed to
vary. A default of 100 was chosen as a reasonable middle ground between
efficiency and realism.</p></li>
<li>
<p>The model allows lists of intervention sets and time-dependence
functions to be passed.</p>
<ul>
<li><p>Only interventions on model parameters are allowed, and
interventions on social contacts are not allowed, as the model does not
include age-stratification in transmission (or otherwise).</p></li>
<li><p>The parameters <code>infectiousness_rate</code> (often denoted
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>)
and <code>removal_rate</code> (recovery or death with safe burial,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>)
<em>cannot</em> be targeted by rate interventions or time-dependence as
these values determine the number of sub-compartments in the exposed and
infectious (and hospitalised) compartments, respectively. These are
fixed at the start of the simulation, and changing them partway is
challenging to support as it would involve redistributing individuals
currently in any sub-compartment into more or fewer
sub-compartments.</p></li>
</ul>
</li>
<li>
<p>The model supports and defaults to multiple replicates or runs
for each parameter-scenario combination.</p>
<ul>
<li><p>For any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
runs with a single parameter set and a single intervention set, runs
will differ due to stochasticity (essentially, as different random
numbers are drawn for each run).</p></li>
<li><p>For any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
runs with multiple parameter sets and a single intervention set, runs
will differ due to stochasticity <em>within</em> parameter sets, but any
differences between runs <em>across</em> parameter sets (e.g. two
different transmission rates) will be due to differences in parameter
values alone.</p></li>
<li><p>For multiple runs of multiple parameter-scenario combinations,
differences among runs will be due to differences in parameters and
composable elements (such as interventions) alone.</p></li>
<li><p>The <a href="https://CRAN.R-project.org/package=withr" class="external-link"><em>withr</em>
package</a> is used to ensure that seeds are preserved across parameter
sets and interventions.</p></li>
</ul>
</li>
<li><p>The input and output types correspond to the ODE model
types.</p></li>
<li>
<p>The model is written in R <a href="https://github.com/epiverse-trace/epidemics/issues/179" class="external-link">although
this may change in future</a>. The main reason for keeping the
implementation in R is that the <code><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">stats::rmultinom()</a></code> function
is a very efficient way of drawing from a categorical distribution
(often called a discrete distribution) with heterogeneous probabilities.
This <a href="https://stackoverflow.com/questions/23097269/efficient-multinomial-sampling-when-sample-size-and-probability-vary" class="external-link">StackOverflow
question from 2014</a> has more details including benchmarks against
other implementations using <em>Rcpp</em>; though old, we have
benchmarked a minimal example using <em>Boost</em> and found that this
information is still valid.</p>
<ul>
<li>One possible reason to switch at least part of the Ebola model
implementation to C++ is to make use of more efficient random number
generation from the GNU Scientific Library via <a href="https://CRAN.R-project.org/package=RcppGSL" class="external-link"><em>RcppGSL</em></a>,
although there may be <a href="https://stackoverflow.com/questions/55976547/linking-gsl-libraries-to-rcppgsl-in-windows-10" class="external-link">issues
for users trying to compile from source on Windows</a>.</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="classes">Classes<a class="anchor" aria-label="anchor" href="#classes"></a>
</h3>
<ul>
<li><p>The major composable elements are bundled into custom S3 classes
that inherit from lists, and which are expected to be understandable
elements of epidemic response: <code>&lt;population&gt;</code>, the
<code>&lt;intervention&gt;</code> superclass, and
<code>&lt;vaccination&gt;</code>. All other composable elements take the
form of named, structured lists. These are not defined as classes
because they are expected to be less used, or used by more advanced
modellers who are comfortable working with lists directly.</p></li>
<li><p>A key element of composable elements being or inheriting from
lists is that they can be easily handled within the C++ code as
<strong>they are interpreted as Rcpp lists</strong>.</p></li>
<li><p>All matrix objects referring to demography-group coefficients
follow the ‘demography-in-rows’ pattern from <em>finalsize</em>, where
rows represent demography groups, and columns represent coefficients.
This includes the initial conditions matrix in
<code>&lt;population&gt;</code>s, where columns are epidemiological
compartments, but also vaccination rates in
<code>&lt;vaccination&gt;</code>, and contacts reductions in
<code>&lt;contacts_intervention&gt;</code>s.</p></li>
<li><p>Interventions may be of the
<code>&lt;contacts_intervention&gt;</code> or
<code>&lt;rate_intervention&gt;</code> class, which inherit from the
abstract super-class <code>&lt;intervention&gt;</code>. This inheritance
structure was chosen to maintain coherence between the intervention
types, and to keep the option open of unifying these classes into a
single concrete type in the future.</p></li>
<li><p>All composable elements except the <code>population</code> are
optional. Model functions internally generate dummy values for the other
composable elements allowed for each model, as these are required for
the C++ code.</p></li>
<li>
<p><code>&lt;intervention&gt;</code> and
<code>&lt;vaccination&gt;</code> objects may be combined with objects of
the same (sub)-class using the <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> method for each
(sub)-class, and resulting in an object of the same (sub)-class. The
interpretation for each class is however slightly different:</p>
<ul>
<li><p><code>&lt;intervention&gt;</code>: Combining two interventions of
the same sub-class is understood to represent the combined application
of multiple epidemic response strategies, e.g. closing schools and also
closing workplaces, or introducing mask mandates over different
intervals.</p></li>
<li><p><code>&lt;vaccination&gt;</code>: Combining two vaccination
objects results in a two-dose vaccination regime, rather than two
separate vaccination campaigns (each delivering a single dose). This is
because <em>epidemics</em> focuses on the initial pandemic response
phase where vaccination is not expected to be available at scale, rather
than long-term vaccination campaigns against endemic
infections.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="function-vectorisation">Function vectorisation<a class="anchor" aria-label="anchor" href="#function-vectorisation"></a>
</h3>
<p><em>epidemics</em> is moving towards allowing vectors or lists to be
passed as model function arguments, to easily allow the incorporation of
parameter uncertainty and comparisons of multiple scenarios (while
maintaining comparability across scenarios in each function call).
Consequently, each function call may consist of many 1000s of model runs
(<a href="https://github.com/epiverse-trace/epidemics/pull/176" class="external-link">see PR
#176</a> and the <a href="modelling_scenarios.html">vignette on scenario
modelling</a>).</p>
<ul>
<li><p>All model epidemiological parameters are allowed to be passed as
numeric vectors (currently only ODE models). This includes
<code>time_end</code>, which allows runs of different durations within a
single function call. This <a href="https://gaza-projections.org/" class="external-link">use
case was taken from this report</a> which aimed to calculate the
epidemic size over a given period with uncertainty in the start time
(and hence the duration). <em>epidemics</em> <a href="https://vctrs.r-lib.org/reference/theory-faq-recycling.html" class="external-link">follows
the Tidyverse rules on vector recycling</a> for epidemiological
parameters.</p></li>
<li><p>Arguments <code>intervention</code> and <code>vaccination</code>
accepting composable elements are allowed to be passed as lists of
inputs. In the case of <code>intervention</code>, this is a list of
lists, with each element a list of <code>&lt;intervention&gt;</code>
objects (typically one <code>&lt;contacts_intervention&gt;</code> and a
variable number of <code>&lt;rate_intervention&gt;</code>s): this is
<strong>referred to as an intervention set</strong>. All other
composable elements may currently only be scalar values, but this may
change in future (<a href="https://github.com/epiverse-trace/epidemics/issues/181" class="external-link">see issue
#181 for passing lists of populations</a>).</p></li>
<li><p>Model functions internally create combinations of composable
elements, and each such combination is referred to as a
<strong>scenario</strong>, and also combine each scenario with each set
of epidemiological parameters. This is to ensure comparability across
scenarios.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="miscellaneous-decisions">Miscellaneous decisions<a class="anchor" aria-label="anchor" href="#miscellaneous-decisions"></a>
</h2>
<ul>
<li><p><em>epidemics</em> follows the <em>finalsize</em> example in
following <a href="https://google.github.io/styleguide/cppguide.html" class="external-link">Google’s C++
code style</a>, and in using <a href="https://github.com/cpplint/cpplint" class="external-link">Cpplint</a> and <a href="https://cppcheck.sourceforge.io/" class="external-link">Cppcheck</a> for static code
analysis as options such as Clang-tidy do not work well with Rcpp code;
<a href="https://epiverse-trace.github.io/posts/lint-rcpp/" class="external-link">see this
blog post</a> for more.</p></li>
<li><p>Function naming: Function names aim to contain verbs that
indicate the function behaviour. Internal input checking functions
follow the <em>checkmate</em> naming style
(e.g. <code>assert_*()</code>).</p></li>
<li><p>Function naming: Internal functions aim to begin with a
<code>.</code> (e.g. .model_default_cpp()) to more clearly indicate that
they are not for direct use.</p></li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a>
</h2>
<p>The aim is to restrict the number of hard dependencies while
maintaining user-friendliness.</p>
<ul>
<li>
<a href="https://CRAN.R-project.org/package=checkmate" class="external-link"><em>checkmate</em></a>:
a useful input-checking package used across Epiverse packages;</li>
<li>
<a href="https://CRAN.R-project.org/package=cli" class="external-link"><em>cli</em></a>
and <a href="https://CRAN.R-project.org/package=glue" class="external-link"><em>glue</em></a>:
convenience packages for pretty printing methods; these could be
reconsidered to lighten package dependencies;</li>
<li>
<a href="https://CRAN.R-project.org/package=data.table" class="external-link"><em>data.table</em></a>:
a lightweight dependency to handle data from model outputs, and
especially used for nested list column functionality.</li>
<li>
<a href="https://CRAN.R-project.org/package=Rcpp" class="external-link"><em>Rcpp</em></a>:
provides linking between C++ and R;</li>
<li>
<a href="https://CRAN.R-project.org/package=RcppEigen" class="external-link"><em>RcppEigen</em></a>:
provides matrix classes suitable for use with Boost
<em>odeint</em>;</li>
<li>
<a href="https://CRAN.R-project.org/package=BH" class="external-link"><em>BH</em></a>:
provides the Boost <em>odeint</em> ODE solvers;</li>
<li>
<a href="https://CRAN.R-project.org/package=withr" class="external-link"><em>withr</em></a>: for
seed management;</li>
<li>
<em>stats</em> and <em>utils</em>: already installed with R, and
used only in the Ebola model, and hence liable to be removed in the
future.</li>
</ul>
<p>A wider range of packages are taken on as soft dependencies to make
the vignettes more user-friendly.</p>
<ul>
<li>
<a href="https://CRAN.R-project.org/package=bench" class="external-link"><em>bench</em></a>: to
benchmark <em>epidemics</em> against <em>finalsize</em>;</li>
<li>
<a href="https://CRAN.R-project.org/package=bookdown" class="external-link"><em>bookdown</em></a>,
<a href="https://CRAN.R-project.org/package=knitr" class="external-link"><em>knitr</em></a>,
<a href="https://CRAN.R-project.org/package=rmarkdown" class="external-link"><em>rmarkdown</em></a>:
packages to generate vignettes and format them;</li>
<li>
<a href="https://CRAN.R-project.org/package=dplyr" class="external-link"><em>dplyr</em></a>, <a href="https://CRAN.R-project.org/package=tibble" class="external-link"><em>tibble</em></a>, <a href="https://CRAN.R-project.org/package=tidyr" class="external-link"><em>tidyr</em></a>: to
show the processing of model outputs;</li>
<li>
<a href="https://CRAN.R-project.org/package=EpiEstim" class="external-link"><em>EpiEstim</em></a>:
to show links with upstream packages that estimate R in a vignette;</li>
<li>
<a href="https://CRAN.R-project.org/package=finalsize" class="external-link"><em>finalsize</em></a>:
for comparison against <em>epidemics</em> in a vignette;</li>
<li>
<a href="https://CRAN.R-project.org/package=ggplot2" class="external-link"><em>ggplot2</em></a>,
<a href="https://CRAN.R-project.org/package=scales" class="external-link"><em>scales</em></a>,
<a href="https://CRAN.R-project.org/package=colorspace" class="external-link"><em>colorspace</em></a>:
packages for plotting;</li>
<li>
<a href="https://CRAN.R-project.org/package=socialmixr" class="external-link"><em>socialmixr</em></a>:
to obtain social contacts matrices;</li>
<li>
<a href="https://CRAN.R-project.org/package=spelling" class="external-link"><em>spelling</em></a>:
for spell-checking;</li>
<li>
<a href="https://CRAN.R-project.org/package=testthat" class="external-link"><em>testthat</em></a>
(&gt;= 3.0.0): for unit tests.</li>
</ul>
</div>
<div class="section level2">
<h2 id="contribute">Contribute<a class="anchor" aria-label="anchor" href="#contribute"></a>
</h2>
<p>There are no special requirements to contributing to
<em>epidemics</em>, but contributions of new models should be clearly
motivated, fall within the scope of the package, target a disease type
or situation that is not already covered by existing models, and ideally
should already be peer-reviewed. In general, please follow the <a href="https://github.com/epiverse-trace/.github/blob/main/CONTRIBUTING.md" class="external-link">package
contributing guide</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pratik Gupte, Rosalind Eggo, Edwin Van Leeuwen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3. Theme provided by <a href="https://github.com/epiverse-trace/epiversetheme" class="external-link">epiversetheme</a> 0.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
