<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Guide to developing epidemics features • epidemics</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Guide to developing epidemics features">
<meta name="robots" content="noindex">
<!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZ471458FQ"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XZ471458FQ');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">
    <a href="https://epiverse-trace.github.io/" class="external-link"><img src="https://epiverse-trace.github.io/blueprints/logo_white.svg" id="logo" alt="Epiverse-TRACE"></a>
    <a class="navbar-brand me-2" href="../index.html">epidemics</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.4.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epidemics.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modelling interventions</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_interventions.html">Getting started with modelling interventions targeting social contacts</a></li>
    <li><a class="dropdown-item" href="../articles/modelling_multiple_interventions.html">Modelling overlapping and sequential interventions targeting social contacts</a></li>
    <li><a class="dropdown-item" href="../articles/modelling_rate_interventions.html">Modelling interventions that change infection parameters</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modelling vaccination</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_vaccination.html">Modelling the effect of a vaccination campaign</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modelling seasonality</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_time_dependence.html">Modelling time-dependence and seasonality in transmission dynamics</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Run models with multiple populations</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_populations.html">Modelling in multiple populations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced modelling</h6></li>
    <li><a class="dropdown-item" href="../articles/modelling_param_uncertainty.html">Modelling parameter uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/modelling_scenarios.html">Modelling intervention scenarios</a></li>
    <li><a class="dropdown-item" href="../articles/finalsize_comparison.html">Reducing parameters required for final size estimation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides to library models</h6></li>
    <li><a class="dropdown-item" href="../articles/model_vacamole.html">Modelling leaky vaccination and hospitalisation outcomes with Vacamole</a></li>
    <li><a class="dropdown-item" href="../articles/model_ebola.html">Modelling responses to a stochastic Ebola virus epidemic</a></li>
    <li><a class="dropdown-item" href="../articles/model_diphtheria.html">Modelling a diphtheria outbreak in a humanitarian camp setting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides for developers</h6></li>
    <li><a class="dropdown-item" href="../articles/design-principles.html">Design principles for epidemics</a></li>
    <li><a class="dropdown-item" href="../articles/developer-walkthrough.html">Guide to developing epidemics features</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epiverse-trace/epidemics/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Guide to developing epidemics features</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epiverse-trace/epidemics/blob/main/vignettes/developer-walkthrough.Rmd" class="external-link"><code>vignettes/developer-walkthrough.Rmd</code></a></small>
      <div class="d-none name"><code>developer-walkthrough.Rmd</code></div>
    </div>

    
    
<p>This vignette is intended to be a guide to making small, targeted
edits to features in <em>epidemics</em>, and is aimed at current and
future contributors, and at advanced users who might want to use a
slightly modified local version of an <em>epidemics</em> provided model
for specific analyses.</p>
<div class="alert alert-warning">
<p><strong>New to developing epidemics?</strong> Please read the <a href="design-principles.html">vignette on design decisions taken during
the development process</a>, and see the concept and architecture
diagrams in that vignette.</p>
</div>
<div class="section level2">
<h2 id="scope">Scope<a class="anchor" aria-label="anchor" href="#scope"></a>
</h2>
<p>This vignette is structured around use cases of making package
modifications given the existing package architecture.</p>
<p>Consequently this vignette does not cover major changes that would
require a substantial rewrite of the package, such as switching the C++
solver used for ODE models, or switching to using <em>cpp11</em> rather
than <em>Rcpp</em>.</p>
<p>This vignette also does not tackle questions around epidemic
modelling choices - such as which compartmental transitions should be
allowed; we strongly recommend the involvement of a specialist in such
cases.</p>
<p>Finally, this vignette relates only to the deterministic ODE models
in <em>epidemics</em>, as these are expected to be the main starting
points for most users seeking to create their own models.</p>
<div class="alert alert-info">
<p><strong>Making substantial changes to a model in epidemics?</strong>
Have you modified an existing model to cover new use cases or disease
types? We welcome contributions of new model structures. Examples
include models targeting vector borne diseases, or diseases with a
sylvatic cycle. Please get in touch via a <a href="https://github.com/epiverse-trace/epidemics/issues" class="external-link">GitHub
Issue</a> or on the <a href="https://github.com/orgs/epiverse-trace/discussions" class="external-link">Epiverse-TRACE
Discussion board</a>!</p>
</div>
</div>
<div class="section level2">
<h2 id="a-guide-to-package-structure">A guide to package structure<a class="anchor" aria-label="anchor" href="#a-guide-to-package-structure"></a>
</h2>
<p>A simplified view of the package structure is shown below. Note the
files indicated by comments in capitals and the associated ‘level’ of
the code; this roughly corresponds to the level in the call stack.</p>
<div class="sourceCode" id="cb1" filename="epidemics/"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">├──</span> DESCRIPTION</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="ex">├──</span> NAMESPACE</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="ex">├──</span> R</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="ex">│  </span> ├── RcppExports.R           <span class="co"># auto-generated from `src/`</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="ex">│  </span> ├── check_args_<span class="pp">*</span>.R          <span class="co"># MODEL-SPECIFIC INPUT CROSS-CHECKING FUNC</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="ex">│  </span> ├── dummy_elements.R        <span class="co"># functions for empty composable elements</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="ex">│  </span> ├── helpers.R               <span class="co"># functions to handle model output</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="ex">│  </span> ├── input_check_helpers.R   <span class="co"># functions to construct cross-checking fns</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="ex">│  </span> ├── intervention.R          <span class="co"># intervention classes</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="ex">│  </span> ├── model_<span class="pp">*</span>.R               <span class="co"># USER-FACING MODEL FUNCTION; LEVEL 1</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="ex">│  </span> ├── population.R            <span class="co"># population class</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="ex">│  </span> ├── tools.R                 <span class="co"># internal utility functions</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="ex">│  </span> └── vaccination.R           <span class="co"># vaccination class</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="ex">├──</span> epidemics.Rproj</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="ex">├──</span> inst</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="ex">│  </span> └── include</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="ex">│  </span>     ├── epidemics.h         <span class="co"># package header, must include all `model_*.h`</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="ex">│  </span>     ├── intervention.h      <span class="co"># functions to handle interventions in C++</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="ex">│  </span>     ├── model_<span class="pp">*</span>.h           <span class="co"># MODEL ODE SYSTEM; LEVEL 3</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="ex">│  </span>     ├── ode_tools.h         <span class="co"># definition of the initial state struct</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="ex">│  </span>     ├── population.h        <span class="co"># functions to handle populations in C++</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="ex">│  </span>     ├── time_dependence.h   <span class="co"># functions to handle time-dependence in C++</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="ex">│  </span>     └── vaccination.h       <span class="co"># functions to handle vaccinations in C++</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="ex">├──</span> man</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a><span class="ex">│  </span> └── <span class="pp">*</span>.Rd                    <span class="co"># R function documentation</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="ex">├──</span> src</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a><span class="ex">│  </span> ├── Makevars                <span class="co"># UNIX make options for Rcpp</span></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="ex">│  </span> ├── Makevars.win            <span class="co"># Windows make options for Rcpp</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a><span class="ex">│  </span> ├── RcppExports.cpp         <span class="co"># auto-generated from `src/`</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a><span class="ex">│  </span> └── model_<span class="pp">*</span>.cpp             <span class="co"># MODEL FUNC WRAPPING ODE SYSTEM; LEVEL 2</span></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a><span class="ex">│</span></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a><span class="ex">├──</span> tests                       <span class="co"># test files</span></span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a><span class="ex">└──</span> vignettes                   <span class="co"># vignettes</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="adding-or-removing-model-parameters">Adding or removing model parameters<a class="anchor" aria-label="anchor" href="#adding-or-removing-model-parameters"></a>
</h2>
<p>Adding or removing parameters to the ODE models involves working with
all levels of the model code.</p>
<p>Consider an example of adding a uniform, age-independent, background
mortality rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ω</mi><annotation encoding="application/x-tex">\omega</annotation></semantics></math>
that is unrelated to the epidemic itself. Removing a parameter involves
reversing these steps.</p>
<ol style="list-style-type: decimal">
<li>
<p>Modify the user-facing model function in <code>R/model_*.R</code>
to accept the mortality rate as an argument; add documentation and input
checks, and ensure that it is included in parameter set creation; this
is <strong>level 1</strong>, the top level, of the code.</p>
<div class="sourceCode" id="cb2" filename="R/model_*.R"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>model_new <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  population,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="sc">&lt;</span>EXISTING PARAMETERS<span class="sc">&gt;</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  mortality_rate,           <span class="co"># &lt;== New parameter added.</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>  <span class="sc">&lt;</span>OTHER ARGUMENTS<span class="sc">&gt;</span>) {}</span></code></pre></div>
</li>
<li>
<p>Modify the internal C++ function in <code>src/model_*.cpp</code>
to accept the mortality rate as an argument of the type
<code>const double</code>; this also applies to integer-like inputs as
the <code>double</code> type is better suited for R’s
<code>numeric</code> type, which most users will be working with. This
is <strong>level 2</strong> of the code, one level down.</p>
<div class="sourceCode" id="cb3" filename="src/model_*.cpp"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">// Note this function is exposed to R but not exported from the package</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">//' [[Rcpp::export(name=".model_NAME_cpp")]]    // &lt;== Use model name.</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>Rcpp<span class="op">::</span>List model_NAME_internal<span class="op">(</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span>initial_state<span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">double</span> <span class="op">&amp;</span>transmission_rate<span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">double</span> <span class="op">&amp;</span>infectiousness_rate<span class="op">,</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">double</span> <span class="op">&amp;</span>recovery_rate<span class="op">,</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">double</span> <span class="op">&amp;</span>mortality_rate<span class="op">,</span>       <span class="co">// &lt;== New parameter added.</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  <span class="op">&lt;</span>OTHER_ARGUMENTS<span class="op">&gt;)</span> <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>    <span class="co">/* model setup and ODE solving */</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>Add the mortality rate to the <code>std::unordered_map</code> of
key-value pairs of parameters and their names, in
<code>src/model_*.cpp</code>; this is used to access the parameters in
the ODE solver, as well as enabling rate interventions and
time-dependence.</p>
<div class="sourceCode" id="cb4" filename="src/model_*.cpp"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>Rcpp<span class="op">::</span>List model_NAME_internal<span class="op">(</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="at">const</span> Eigen<span class="op">::</span>MatrixXd <span class="op">&amp;</span>initial_state<span class="op">,</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">double</span> <span class="op">&amp;</span>transmission_rate<span class="op">,</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">double</span> <span class="op">&amp;</span>infectiousness_rate<span class="op">,</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">double</span> <span class="op">&amp;</span>recovery_rate<span class="op">,</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">double</span> <span class="op">&amp;</span>mortality_rate</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  <span class="op">&lt;</span>OTHER_ARGUMENTS<span class="op">&gt;)</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    <span class="co">// create a map of the model parameters</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    <span class="bu">std::</span>unordered_map<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">,</span> <span class="dt">double</span><span class="op">&gt;</span> model_params<span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>        <span class="op">{</span><span class="st">"transmission_rate"</span><span class="op">,</span> transmission_rate<span class="op">},</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>        <span class="op">{</span><span class="st">"infectiousness_rate"</span><span class="op">,</span> infectiousness_rate<span class="op">},</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>        <span class="op">{</span><span class="st">"recovery_rate"</span><span class="op">,</span> recovery_rate<span class="op">},</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>        <span class="op">{</span><span class="st">"mortality_rate"</span><span class="op">,</span> mortality_rate<span class="op">}</span>    <span class="co">// &lt;== New parameter added.</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>    <span class="co">/* ODE solving */</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>Modify the compartmental transitions in the
<code>FunctionObject</code> ODE model
<code>inst/include/model_*.h</code> appropriately to include the
mortality rate. This is <strong>level 3</strong> of the code, two levels
down.</p>
<div class="sourceCode" id="cb5" filename="inst/include/model_*.h"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">namespace</span> epidemics <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="kw">struct</span> epidemic_new <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="co">// Model elements as struct members</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="co">// two maps for the model parameters, one for dynamic modification</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="at">const</span> <span class="bu">std::</span>unordered_map<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">,</span> <span class="dt">double</span><span class="op">&gt;</span> model_params<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="bu">std::</span>unordered_map<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">,</span> <span class="dt">double</span><span class="op">&gt;</span> model_params_temp<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>  <span class="op">&lt;</span>OTHER STRUCT MEMBERS<span class="op">&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  <span class="co">// constructor</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>  epidemic_new<span class="op">(&lt;</span>ARGUMENTS<span class="op">&gt;)</span> <span class="op">:</span> <span class="op">&lt;</span>CONSTRUCTOR LIST<span class="op">&gt;</span> <span class="op">{}</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  <span class="co">// overloaded operator</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span><span class="at">const</span> odetools<span class="op">::</span><span class="dt">state_type</span><span class="op">&amp;</span> x<span class="op">,</span>    <span class="co">// the current state</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>            odetools<span class="op">::</span><span class="dt">state_type</span><span class="op">&amp;</span> dxdt<span class="op">,</span>             <span class="co">// change in state</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>            <span class="at">const</span> <span class="dt">double</span> t<span class="op">)</span> <span class="op">{</span>                       <span class="co">// the current time</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    <span class="co">/* dynamic parameter calculation here */</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    <span class="co">// implement background mortality rate here</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>    <span class="co">// </span><span class="al">NOTE</span><span class="co">: compartments are hard-coded as column positions</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>    <span class="co">// and demographic groups are rows.</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>    <span class="co">// Accessed columns must be converted to arrays for</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>    <span class="co">// vectorised operations.</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>    <span class="co">// For the 0-th column, i.e., susceptibles</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>    dxdt<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> <span class="op">&lt;</span>NEW INFECTIONS AND VACCINATIONS<span class="op">&gt;</span> <span class="op">-</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>      <span class="op">(</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>        model_params_temp<span class="op">.</span>at<span class="op">(</span><span class="st">"mortality_rate"</span><span class="op">)</span> <span class="op">*</span>    <span class="co">// mortality rate *</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>          x<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">).</span>array<span class="op">()</span>                          <span class="co">// susceptibles</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>      <span class="op">);</span></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>    <span class="co">// and so on for all i columns in x</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</li>
<li><p>Write or update unit tests to check for the statistical
correctness of the model with the newly added parameter (e.g., for this
example, test that a non-zero mortality rate leads to fewer individuals
at the end of the model than at the start).</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="modifying-compartmental-flows-without-changing-compartments">Modifying compartmental flows without changing compartments<a class="anchor" aria-label="anchor" href="#modifying-compartmental-flows-without-changing-compartments"></a>
</h2>
<p>Modifying compartmental flows is straightforward for the ODE models
in <em>epidemics</em>.</p>
<div class="alert alert-warning">
<p><strong>Note that</strong> existing compartmental flows are typically
controlled by infection parameters, which can be set to zero to disallow
specific transitions. For example, to simulate a scenario in which
hospitalisation is not available, the Vacamole model can be run with the
argument <code>hospitalisation_rate = 0.0</code>.</p>
<p>Please check whether setting an infection parameter to zero better
suits your use case.</p>
</div>
<p>This section focuses on adding novel inflows and outflows via some
illustrative examples. The initial steps are similar to those for adding
a model parameter, and are summarised here. The section on <a href="#vector-parameters">adding group-specific parameters</a> covers
how to add parameters with dimensions &gt; 1.</p>
<ol style="list-style-type: decimal">
<li><p>First, navigate to the end of each model
<code>FunctionObject</code> defined in
<code>inst/include/model_*.h</code> and edit the ODEs found there (see
examples below). Users can hard-code the parameter values in these files
for quick edits, but we recommend taking the next few steps to allow
changing these values from R.</p></li>
<li><p>Next, modify the C++ function arguments in
<code>src/model_*.cpp</code> so that any newly added rate parameters can
be passed from R to C++. Typically, single parameters should be passed
by reference as <code>const double</code>.</p></li>
</ol>
<ul>
<li>If you seek to use time-dependence and rate interventions with the
newly added parameters should follow the steps in the section
above.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><p>Finally, modify the R code in <code>R/model_*.R</code> so that
the R function accepts the new parameter as an appropriately checked
argument.</p></li>
<li><p>When adding parameters such as birth and death rates, make sure
that this is accounted for in any unit tests (see especially the current
expectation in most models that there is a constant population
size).</p></li>
</ol>
<div class="alert alert-info">
<p>We will consider a number of modifications to the susceptible
compartment in the default model, which we assume to be given by
<code>dxdt.col(0) = -sToE - sToV;  // -β*S*contacts*I - ν</code>, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
is the transmission rate,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ν</mi><annotation encoding="application/x-tex">\nu</annotation></semantics></math>
is the number of vaccinations, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>,</mo><mi>I</mi><mo>,</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">S, I, V</annotation></semantics></math>
represent the susceptible and infectious compartments, respectively.</p>
</div>
<div class="section level3">
<h3 id="modelling-births-immigration-and-background-mortality">Modelling births, immigration, and background mortality<a class="anchor" aria-label="anchor" href="#modelling-births-immigration-and-background-mortality"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Inflows into the model population may occur into any
epidemiological compartment. Here we consider inflows into the
susceptible compartment of the default model, denoted by the value
<code>B</code>. These can be added to the compartmental transition as
shown below. Note that <code>B</code> represents counts and not the
per-capita birth rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>,
in contrast with the background mortality rate below.</p>
<div class="sourceCode" id="cb6" filename="inst/include/model_*.h"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">// Add births to S</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>dxdt<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> B <span class="op">-</span>sToE <span class="op">-</span> sToV<span class="op">;</span>  <span class="co">// B -β*S*contacts*I - ν</span></span></code></pre></div>
<p>Outflows attributed to background mortality may occur in all
compartments, and can be represented as a fraction
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>d</mi><annotation encoding="application/x-tex">d</annotation></semantics></math>
of the compartment value as shown below.</p>
<div class="sourceCode" id="cb7" filename="inst/include/model_*.h"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co">// Following above, add deaths to S, where d is the mortality rate</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">// x.col(0) is the current or initial state of the susceptibles</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>dxdt<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> B <span class="op">-</span>sToE <span class="op">-</span> sToV <span class="op">-</span> <span class="op">(</span>d <span class="op">*</span> x<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)).</span>array<span class="op">();</span>  <span class="co">// B -β*S*contacts*I - ν - (dS)</span></span></code></pre></div>
<p>For a model with age stratification, note that <code>B</code> and
<code>d * S</code>
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>i</mi></msub><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">d_i S_i</annotation></semantics></math>)
have to be of the type <code>Eigen::ArrayXd</code>, and of the same
length as the number of demographic groups, to represent the flows in to
and out of each age group.</p>
</li>
<li>
<p>To simulate births as the only inflow in an age-stratified model,
<code>B</code> must have the same length as <code>N</code>, with only
the first element having a non-zero value. <code>B</code> is still
required to be a vector for compatibility with other vector/array
elements. Setting other values of <code>B</code> to be non-zero positive
values can be used to model immigration or other long-term
processes.</p>
<div class="sourceCode" id="cb8" filename="inst/include/model_*.h"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">// where `x` is the current state matrix</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">// get current population size</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">// recall rows are demography groups, columns are compartments</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="at">const</span> Eigen<span class="op">::</span>ArrayXd demography_vector <span class="op">=</span> x<span class="op">.</span>rowwise<span class="op">().</span>sum<span class="op">();</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">// define a per-capita birth rate</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> b <span class="op">=</span> <span class="fl">1e-3</span><span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co">// calculate total birth rate as per-capita rate * population size</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="dt">double</span> <span class="va">births_</span> <span class="op">=</span> <span class="op">(</span>b <span class="op">*</span> demography_vector<span class="op">.</span>sum<span class="op">());</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co">// create the vector `B`</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>Eigen<span class="op">::</span>ArrayXd births<span class="op">(</span><span class="dv">4</span><span class="op">);</span>  <span class="co">// hardcoded for four age groups</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="co">// fill all values as 0.0</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>births<span class="op">.</span>fill<span class="op">(</span><span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="co">// set the first value to births_, all others are zero</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>births<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> <span class="va">births_</span><span class="op">;</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="co">// Replace `B` with `births`</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>dxdt<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> births <span class="op">-</span>sToE <span class="op">-</span> sToV<span class="op">;</span>  <span class="co">// B -β*S*contacts*I - ν</span></span></code></pre></div>
</li>
<li>
<p>To add an immigration component, continue from the example above.
Note that ‘immigration’ here is used in the population dynamics sense of
the term, and simply means individuals entering the population. See the
section of <a href="#vector-parameters">group-specific model
parameters</a> for how to vary the immigration rate per demographic
group.</p>
<div class="sourceCode" id="cb9" filename="inst/include/model_*.h"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">// a uniform value for the rate of immigration in all age groups</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> immigration_rate <span class="op">=</span> SOME_VALUE<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">// calculate immigration as a proportion of each age group</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="at">const</span> Eigen<span class="op">::</span>ArrayXd immigration <span class="op">=</span> immigration_rate <span class="op">*</span> population_size<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co">// sum births and immigration</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="at">const</span> Eigen<span class="op">::</span>ArrayXd all_inflows <span class="op">=</span> births <span class="op">+</span> immigration<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co">// Replace `B` with `all_inflows`</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>dxdt<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> all_inflows <span class="op">-</span>sToE <span class="op">-</span> sToV<span class="op">;</span>  <span class="co">// B -β*S*contacts*I - ν</span></span></code></pre></div>
</li>
<li><p>Deaths from each compartment can be similarly included.
Background mortality, i.e., not related to the epidemic can be modelled
as a vector of mortality rates <code>d</code> multiplied by the size of
each demographic group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
in any compartment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>,
as either
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi>d</mi><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">-dX_i</annotation></semantics></math>
for uniform background mortality, or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><msub><mi>d</mi><mi>i</mi></msub><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">-d_i X_i</annotation></semantics></math>
for age-specific mortality.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="modelling-sources-of-infectious-individuals-such-as-from-zoonotic-spillover_rate">Modelling sources of infectious individuals such as from zoonotic
spillover_rate<a class="anchor" aria-label="anchor" href="#modelling-sources-of-infectious-individuals-such-as-from-zoonotic-spillover_rate"></a>
</h3>
<p>Define a uniform spillover rate and add this to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>→</mo><mi>I</mi></mrow><annotation encoding="application/x-tex">S \rightarrow I</annotation></semantics></math>
transition.</p>
<div class="sourceCode" id="cb10" filename="inst/include/model_*.h"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">// define a uniform spillover rate from contact with animals</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> spillover_rate <span class="op">=</span> SOME_VALUE<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">// include this additional S -&gt; E transition</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">// note x.col(0).array() is the vector of age-specific susceptibles</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">// each model header file </span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="at">const</span> Eigen<span class="op">::</span>ArrayXd zoonotic_infection <span class="op">=</span> spillover_rate <span class="op">*</span> x<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">).</span>array<span class="op">();</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>dxdt<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> <span class="op">-</span>sToE <span class="op">-</span> sToV <span class="op">-</span> zoonotic_infection<span class="op">;</span>  <span class="co">// -β*S*contacts*I - ν - zoonotic infection</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="modelling-waning-immunity">Modelling waning immunity<a class="anchor" aria-label="anchor" href="#modelling-waning-immunity"></a>
</h3>
<p>Similar to previous examples, define a uniform waning rate for the
immunity of recovered individuals and modify the appropriate
compartmental transitions.</p>
<div class="sourceCode" id="cb11" filename="inst/include/model_*.h"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">// define an age-specific waning rate</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="at">const</span> <span class="dt">double</span> waning_rate <span class="op">=</span> SOME_VALUE<span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">// include this new R -&gt; S transition</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co">// note x.col(3).array() is the vector of age-specific recovereds</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="at">const</span> Eigen<span class="op">::</span>ArrayXd re_susceptibles <span class="op">=</span> waning_rate <span class="op">*</span> x<span class="op">.</span>col<span class="op">(</span><span class="dv">3</span><span class="op">).</span>array<span class="op">();</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co">// add individuals with renewed susceptibility</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>dxdt<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> <span class="op">-</span>sToE <span class="op">-</span> sToV <span class="op">+</span> re_susceptibles<span class="op">;</span>  <span class="co">// -β*S*contacts*I - ν - re_susceptibles</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="modifying-which-parameters-can-be-time-dependent">Modifying which parameters can be time dependent<a class="anchor" aria-label="anchor" href="#modifying-which-parameters-can-be-time-dependent"></a>
</h2>
<p>Making the infection parameters of existing models time-dependent is
straightforward using the <code>time_dependence</code> argument to model
functions. Currently, all models support time-dependence on most
infection parameters. This <em>does not include</em> the vaccination
rate (see more on that below).</p>
<p>See the <a href="modelling_time_dependence.html">vignette on
time-dependence</a> for how this functionality currently works.</p>
<p>To modify which parameters of new or existing models can be made
(optionally) time-dependent using the existing functionality:</p>
<ol style="list-style-type: decimal">
<li><p>For <strong>ODE models</strong>, first modify the
<code>std::unordered_map</code> named <code>model_params</code> in the
corresponding model source file, <code>src/model_*.cpp</code>, to add or
remove a key-value pair. Adding a parameter to this map automatically
enables both time-dependence as well as rate interventions; removing a
parameter from this map means disallowing both.</p></li>
<li>
<p>Next, modify the model functions and the argument cross-checking
functions to ensure that the model allows time-dependence and rate
interventions on the correct set of infection parameters.</p>
<ul>
<li><p>The vector of allowed targets for time-dependence is an argument
to the function <code><a href="../reference/cross_checking_inputs.html">.cross_check_timedep()</a></code> called in
<code>model_*()</code> from <code>R/model_*.R</code>, while the vector
of allowed targets for rate interventions is a similar argument to the
function <code><a href="../reference/cross_checking_inputs.html">.cross_check_intervention()</a></code> called in
<code>.check_prepare_args_*()</code> from <code>R/check_args_*.R</code>;
in all cases <code>*</code> refers to the model name.</p></li>
<li><p>This initial cross-checking is required to prevent errors in the
C++ code (typically, a key-not-found error) which may be difficult for
users to understand and fix.</p></li>
</ul>
</li>
<li><p>Finally, ODE model code can be simplified to remove
time-dependence (and rate interventions, or one of them) entirely by
deleting the call to <code>time_dependence::apply_time_dependence</code>
in the ODE model <code>FunctionObject</code> in
<code>inst/include/model_*.h</code>. This will not affect upstream code,
and may be one way of gaining a small improvement in model performance,
so long as time-dependence is not required.</p></li>
<li>
<p>For the <strong>stochastic Ebola model</strong>, infection
parameters are held in a named list called <code>parameters</code>. The
elements of this list that are targeted for time-dependence are modified
within the model loop.</p>
<ul>
<li><p>Adding parameters to the list allows them to be be targeted by
inbuilt time-dependence functionality.</p></li>
<li><p><em>However</em>, removing parameters from the list will lead to
errors as they are needed for compartmental transitions. Instead, add
input checks on the arguments <code>intervention</code> and
<code>time_dependence</code> to prevent these elements from being
modified.</p></li>
<li><p>Remove the appropriate code from within the loop to completely
disallow time-dependence and rate interventions without affecting
upstream code.</p></li>
<li><p><em>Note that</em> the Ebola model does support modifying the
infectiousness rate or the removal rate, as these are used to calculate
the number of sub-compartments (representing days) in each
epidemiological compartment; these values must remain fixed throughout
the model’s run time.</p></li>
</ul>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="vector-parameters">Group-specific infection parameters<a class="anchor" aria-label="anchor" href="#vector-parameters"></a>
</h2>
<p><em>epidemics</em> ODE models can be modified to support
group-specific infection parameters instead of uniform, population-wide
parameters. This is essentially how vaccinations are implemented. Note
that the Ebola model does not support age-stratification and is not
discussed here.</p>
<p>Since <em>epidemics</em> focuses on general models for use within the
first 100 days of a pandemic, it does not currently support
groups-specific parameters. Supporting these parameters in the ODE
models would require a substantial rewrite of how <em>epidemics</em> is
vectorised.</p>
<ol style="list-style-type: decimal">
<li><p>First, in the C++ function signature in
<code>src/model_*.cpp</code> change the type of the parameter to
<code>Eigen::ArrayXd</code>.</p></li>
<li><p>Next, in <code>src/model_*.cpp</code>, remove the parameter from
inclusion in the <code>std::unordered_map</code> of parameters to
prevent initialisation errors (as the map types are
<code>std::string</code> and <code>double</code>). This means
time-dependence and rate interventions cannot be applied to this
parameter.</p></li>
<li><p>Modify the model ODE <code>struct</code> constructor in
<code>inst/include/model_*.h</code> to require an
<code>Eigen::ArrayXd</code> for the group-specific parameter, and define
the parameter as a <code>struct</code> member (initialised from the
constructor).</p></li>
<li><p>Modify ODEs to use the parameter vector/array as appropriate, by
simply replacing the single parameter with the parameter vector in the
ODE code.</p></li>
<li><p>Ensure that all R wrapper code – especially input checking and
cross-checking code – is updated to reflect that one or more infection
parameters are now vectors.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="adding-epidemiological-compartments">Adding epidemiological compartments<a class="anchor" aria-label="anchor" href="#adding-epidemiological-compartments"></a>
</h2>
<p>Adding epidemiological compartments is similar to modifying
compartmental transitions, but requires a few extra steps.</p>
<ol style="list-style-type: decimal">
<li><p>Add and modify model ODEs as appropriate in
<code>inst/include/model_*.h</code> (see sections above).</p></li>
<li><p>Modify the <code>compartments</code> vector in
<code>R/model_*.R</code> to include the name of the new compartment.
This is used both in checking that the input
<code>&lt;population&gt;</code> has the correct number of compartments
in its initial state matrix, as well as for formatting the output
data.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="changing-vaccination-rates-over-time">Changing vaccination rates over time<a class="anchor" aria-label="anchor" href="#changing-vaccination-rates-over-time"></a>
</h2>
<p><em>epidemics</em> treats vaccination as special process that
requires a composable element in the form of an S3 class,
<code>&lt;vaccination&gt;</code>, which allows defining time-limited,
group-specific vaccination rates for multiple vaccination doses if
necessary.</p>
<p>Vaccination is only strictly allowed in the ODE models ‘default’ and
‘Vacamole’, and these are covered here. Begin by dismantling the model
code to remove any functionality related to the
<code>&lt;vaccination&gt;</code> class.</p>
<ol style="list-style-type: decimal">
<li><p>Modify <code>R/model_*.R</code> to remove
<code>vaccination</code> from the function arguments, and any input
checking on the <code>vaccination</code> argument. Also remove the
inclusion of <code>vaccination</code> in the model arguments
<code>&lt;data.table&gt;</code>.</p></li>
<li><p>Remove any cross-checking of the <code>vaccination</code> against
the <code>population</code> in <code>R/check_args_*.R</code>, and remove
the inclusion of <code>vax_time_begin</code>, <code>vax_time_end</code>,
and <code>vax_nu</code> from the return of the function
<code>.check_prepare_args_*()</code>.</p></li>
<li><p>Remove the <code>vax_time_begin</code>,
<code>vax_time_end</code>, and <code>vax_nu</code> arguments from the
model ODE <code>struct</code> constructor in
<code>inst/include/model_*.h</code>; also remove these from the model
object initialisation in <code>src/model_*.cpp</code>. Remove any code
related to calculating current vaccination rates from the model ODE
code.</p></li>
<li><p>At this stage, the ODE model does not support vaccination using a
<code>&lt;vaccination&gt;</code>, and any existing “vaccinated”
compartment is essentially isolated from the other compartments, as the
value of <code>current_nu</code></p></li>
<li><p>Next, follow the steps described above to re-establish
compartmental transitions from the appropriate compartments to the
vaccinated compartment, using either a single population-wide
vaccination rate, or an age-specific rate.</p></li>
<li><p><strong>Note that</strong> the number of individuals vaccinated
should be calculated as counts, and not a rate, when used in
compartmental transitions. This is because the rate of vaccination is
typically specified as a proportion of the total population, or of age
groups, and should be dependent on the number of individuals available
to vaccinate.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pratik Gupte, Rosalind Eggo, Edwin Van Leeuwen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3. Theme provided by <a href="https://github.com/epiverse-trace/epiversetheme" class="external-link">epiversetheme</a> 0.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
