---
title: "Modelling ebolavirus disease with a stochastic model"
output:
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
bibliography: references.json
link-citations: true
vignette: >
  %\VignetteIndexEntry{Modelling ebolavirus disease with a stochastic model}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  dpi = 150
)
```

::: {.alert .alert-warning}
**New to _epidemics_?** It may help to read the ["Get started"](epidemics.html) vignette first!
:::

This vignette shows how to model an epidemic in which stochasticity is expected to play an important role.
This is often the case with outbreaks of infections such as ebolavirus disease (EVD, or simply, ebola).

_epidemics_ includes a compartmental model of ebola based on @getz2018 and adapted from [Epirecipes](http://epirecip.es/epicookbook/chapters/erlang/r).

This model has six compartments --- susceptible, exposed, infectious, hospitalised, funeral, and recovered [@li2019].
The model does not include demographic variation in contacts, as ebola spreads primarily among contacts caring for infected individuals, making age or demographic structure less important.

This model can currently accommodate interventions on model rates only (as there are no demographic groups for contacts interventions).
The only rate in the model that can be influenced by an intervention is the transmission rate $\beta$.

```{r setup}
# some initial setup to load necessary packages
library(epidemics)
library(data.table)
library(ggplot2)
```

## Prepare population and initial conditions

Prepare population data --- for this model, we only need the total population size and the initial conditions.

We can create a `<population>` object with dummy values for the contact matrix, and assign the total size to the demography vector.

We prepare a population with a total size of 14 million, corresponding to the population of Guinea, a West African country where the 2014 ebolavirus epidemic originated.

We assume that 1 person is initially infected and infectious, and 10 other people have been exposed and is yet to become infectious.

```{r}
population_size <- 14e6

# prepare initial conditions as proportions
initial_conditions <- c(
  S = population_size - 11, E = 10, I = 1, H = 0, F = 0, R = 0
) / population_size
```


```{r}
# prepare a <population> object
guinea_population <- population(
  name = "Guinea",
  contact_matrix = matrix(1), # note dummy value
  demography_vector = 14e6, # 14 million, no age groups
  initial_conditions = matrix(
    initial_conditions,
    nrow = 1
  )
)

guinea_population
```

## Prepare pathogen parameters

We prepare an `<infection>` class object for ebola, with an $R_0$ taken from the value estimated for ebola in Guinea [@althaus2014].

We assume that ebola has a mean infectious period of 12 days, and that the time between exposure and symptom onset --- the pre-infectious period --- is 5 days.

This model does not yet have an explicit "deaths" compartment, but rather, the "removed" compartment holds all individuals who have recovered and who have died and been buried safely (see **Details**).
Functionally, they are similar as they are not part of the model dynamics.

We assume that only 10% of infectious individuals are hospitalised, and that hospitalisation achieves a modest 30% reduction in transmission between hospitalised individuals and those still susceptible.
We assume also that any deaths in hospital lead to ebola-safe funerals, such that no further infections result from them.

We assume that infectious individuals who are not hospitalised die in the community, and that their funerals are potentially not ebola-safe.
We assume that the transmission rate of ebola at funerals is 50% of the baseline transmission rate.
This can also be interpreted as the proportion of funerals that are ebola-safe.

```{r}
# Prepare ebola parameters as an infection class object
ebola <- infection(
  name = "ebolavirus disease",
  r0 = 1.5,
  infectious_period = 12,
  preinfectious_period = 5,
  prop_hospitalised = 0.1,
  etu_safety = 0.3,
  funeral_safety = 0.5
)

# print to visualise
ebola
```

## Run epidemic model

We run the model using the function `epidemic_ebola_r()`.
While there is a C++ equivalent of this model, it was not found to be much faster than the R-only version, and is not made available to users.

The model is run for 100 days, with data reported on each day.
This is an appropriate period over which to obtain initial predictions for the outbreak, and after which response efforts such as non-pharmaceutical interventions and vaccination campaigns are likely to be launched to bring the outbreak under control.

```{r}
# set seed to get consistent results
set.seed(0)

# run the epidemic model using `epidemic`
# we call the model "ebola" from the library
data <- epidemic_ebola_r(
  population = guinea_population,
  infection = ebola,
  time_end = 100
)

# view the head of the output
head(data)
```

## Prepare data and visualise infections

We plot the ebola epidemic over time, showing the number of individuals exposed and infectious.

```{r class.source = 'fold-hide'}
# plot figure of epidemic curve
ggplot(
  data[compartment %in% c("exposed", "infectious"), ],
  aes(
    x = time,
    y = value,
    colour = compartment
  )
) +
  geom_line() +
  scale_y_continuous(
    labels = scales::comma
  ) +
  scale_colour_brewer(
    palette = "Dark2",
    name = NULL,
    labels = c("Exposed", "Infectious")
  ) +
  expand_limits(
    x = c(0, 101)
  ) +
  theme_bw() +
  theme(
    legend.position = "top"
  ) +
  labs(
    x = "Simulation time (days)",
    linetype = "Compartment",
    y = "Individuals"
  )
```

## Consensus estimates from multiple model iterations

Since the ebola model is a stochastic one, model results will vary in each run.
We can run the model multiple times --- here, 100 times --- and plot the number of infectious people, to get a consensus idea of what an ebola outbreak might look like.

```{r}
# set seed for consistent output
set.seed(1)

# run the simulation 100 times
data <- Map(
  x = seq(100),
  f = function(x) {
    data <- epidemic_ebola_r(
      population = guinea_population,
      infection = ebola,
      time_end = 100
    )

    # add replicate number and return data
    data$replicate <- x
    data
  }
)

# use data.table to collect the data
data_timeseries <- rbindlist(data)
```

We plot the data.

```{r class.source = 'fold-hide'}
ggplot(data_timeseries[compartment == "infectious", ]) +
  geom_line(
    aes(time, value, group = replicate),
    alpha = 0.3, colour = "grey50"
  ) +
  stat_summary(
    aes(time, value),
    geom = "ribbon",
    fill = "red", alpha = 0.5
  ) +
  stat_summary(
    aes(time, value),
    geom = "line"
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  expand_limits(
    x = c(0, 101)
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_bw() +
  theme(
    legend.position = "top"
  ) +
  labs(
    x = "Simulation time (days)",
    y = "Individuals infectious with ebola"
  )
```

We observe that model stochasticity leads to wide variation in model outcomes, and not all simulation replicates lead to exponential growth of the outbreak within the first 100 days.
However, in a number of replicates, the outbreak has only a low daily incidence within the simulation time, although these replicates might show exponential growth later.

We can find the 'final size' of each replicate using the `epidemic_size()` function on the original simulation data.
Note that the final size here refers to the final size after 365 days, which is the duration of our simulation.

```{r}
# apply the function over each replicate
data_final_size <- Map(
  data,
  f = epidemic_size, deaths = FALSE, by_group = FALSE
)
data_final_size <- unlist(data_final_size)
```

```{r class.source = 'fold-hide'}
# plot a histogram of the replicates
ggplot() +
  geom_histogram(
    aes(data_final_size),
    fill = "steelblue"
  ) +
  scale_x_continuous(
    labels = scales::comma
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_bw() +
  theme(
    legend.position = "top"
  ) +
  labs(
    x = "Epidemic size at 100 days",
    y = "Number of replicates"
  )
```

We see that while some replicates affect over 3,000 individuals within the first 100 days, most replicates have fewer than 500 cases, suggesting that responses to halt the spread of ebola may be quite effective in most real outbreaks.

## Applying interventions that reduce transmission

An intervention that reduces transmission can be applied by passing a `<rate_intervention>` on the transmission rate parameter, `beta`.

We model an intervention that begins 30 days into the outbreak, and reduces transmission by 20%. T

```{r}
# create an intervention on the transmission rate
reduce_transmission <- intervention(
  type = "rate",
  time_begin = 30, time_end = 100, reduction = 0.2
)
```

We can pass the intervention to the model function's `intervention` argument.

```{r}
# set a seed for comparison with the baseline model
set.seed(0)

# run the epidemic model and save data as the baseline
data_baseline <- epidemic_ebola_r(
  population = guinea_population,
  infection = ebola,
  time_end = 100
)

set.seed(0)
# note that the intervention is passed within a list,
# where it is named for the rate it is targeting
data_intervention <- epidemic_ebola_r(
  population = guinea_population,
  infection = ebola,
  intervention = list(
    beta = reduce_transmission
  ),
  time_end = 100
)

# assign scenario names
data_baseline$scenario <- "baseline"
data_intervention$scenario <- "intervention"

# bind the data together
data_scenarios <- rbindlist(list(data_baseline, data_intervention))
```

```{r}
ggplot(data_scenarios[compartment == "infectious", ]) +
  geom_vline(
    xintercept = 30,
    linetype = "dotted"
  ) +
  geom_line(
    aes(time, value, colour = scenario)
  ) +
  scale_colour_brewer(
    palette = "Set1",
    name = "Scenario",
    labels = c("Baseline", "Intervention")
  ) +
  theme_bw() +
  theme(
    legend.position = "top"
  ) +
  labs(
    x = "Days",
    y = "Number of individuals infectious"
  )
```


## Details: Discrete-time ebola virus disease model

This model has compartments adopted from a consensus model for Ebola virus disease presented in [@li2019], and with transitions between epidemiological compartments modelled using Erlang sub-compartments adapted from [@getz2018].

The R code for this model is adapted from code by Hạ Minh Lâm and initially made available on _Epirecipes_ (https://github.com/epirecipes/epicookbook) under the MIT licence.

The model implementation differs from @getz2018 in allowing users to set the basic reproductive number $R_0$, and the mean infectious ($\rho^I$ in Getz and Dougherty) and pre-infectious periods in days ($\rho^E$ in Getz and Dougherty).
Getz and Dougherty instead calculate these from other model parameters.

The shape of the Erlang distributions of passage times through the exposed and infectious compartments ($k^E$ and $k^I$) are fixed to 2 (this was allowed to vary in Getz and Dougherty).

The transition rates between the exposed and infectious, and infectious and funeral compartments, $\gamma^E$ and $\gamma^I$ in Getz and Dougherty's notation, are calculated following their equation (6).

$$\gamma^E = \dfrac{k^E}{\rho^E} = \dfrac{2}{\rho^E} ~\text{and}~
\gamma^I = \dfrac{k^I}{\rho^I} = \dfrac{2}{\rho^I}$$

In this discrete time model, $\gamma^E$ and $\gamma^I$ are used to determine the number of Erlang sub-compartments in each epidemiological compartment, and the probability of newly exposed or infectious individuals beginning in one of the compartments (thus allowing for variation in passage times).

### Hospitalisation, funerals, and removal

Infectious individuals have a probability $p_\text{hosp}$ of being transferred to the hospitalised compartment.
This compartment has the same number of sub-compartments, which means that an infectious individual with $N$ timesteps before exiting the infectious compartment will exit the hospitalised compartment in the same time.

Hospitalised individuals can contribute to transmission of Ebola to susceptibles depending on the value of $p_\text{ETU}$, which is the probability (or proportion) of hospitalised cases contributing to the infection of susceptibles.
This is interpreted as the relative safety of Ebolavirus treatment units (ETUs), with a range of 0.0 -- 1.0, where 0.0 indicates that hospitalisation does not reduce transmission at all, while 1.0 indicates that hospitalisation prevents onward transmission entirely.
This is passed as the `etu_safety` value of the `<infection>`-class object passed to the `infection` argument in `epidemic_ebola_r()`.

We assume that deaths in hospital lead to Ebola-safe funerals, and individuals exiting the hospitalised compartment move to the 'removed' compartment, which holds both recoveries and deaths.

We assume that deaths outside of hospital lead to funerals that are potentially not Ebola-safe, and the contribution of funerals to Ebola transmission is determined by $p_{funeral}$, which can be interpreted as the probability of transmission at a funeral, or the proportion of funerals that are Ebola-safe.
The relative safety of funerals is passed as the `funeral_safety` value of the `infection` argument.

Individuals are assumed to spend only a single timestep in the funeral transmission compartment, before they move into the 'removed' compartment. Individuals in the 'removed' compartment do no affect model dynamics.

## References
