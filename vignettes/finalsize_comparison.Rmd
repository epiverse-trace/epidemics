---
title: "finalsize_comparison"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{finalsize_comparison}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(epidemics)
library(tidyverse)
```

# Comparison with simple SEIR-V model

## SEIR-V model

```{r}
# load contact and population data from socialmixr::polymod
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)

# prepare contact matrix
contact_matrix <- t(contact_data$matrix)

# prepare the demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)

# initial conditions: one in every 1 million is infected
initial_i <- 1e-6
initial_conditions <- c(
  S = 1 - initial_i, E = 0, I = initial_i, R = 0, V = 0
)

# build for all age groups
initial_conditions <- rbind(
  initial_conditions,
  initial_conditions,
  initial_conditions
)
rownames(initial_conditions) <- rownames(contact_matrix)

# prepare the population to model as affected by the epidemic
uk_population <- population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  initial_conditions = initial_conditions
)

# simulate a pandemic, with an R0,
# an infectious period, and an pre-infectious period
pandemic_influenza <- infection(
  r0 = 1.5,
  preinfectious_period = 3,
  infectious_period = 7
)

# run an epidemic model using `epidemic()`
output <- epidemic_default_cpp(
  population = uk_population,
  infection = pandemic_influenza,
  time_end = 600, increment = 1.0
)
output |>
  dplyr::filter(compartment %in% c("susceptible", "recovered")) -> plot_dat

ggplot(plot_dat) +
  geom_line(aes(x = time, y = value, colour = compartment)) +
  facet_grid(demography_group ~ .)
```

```{r}
# Calculate the attack rate using the fraction of recovered
output |>
  dplyr::filter(time == max(time)) |>
  dplyr::reframe(value = value/sum(value), compartment, .by = c("demography_group")) |>
  dplyr::filter(compartment == "recovered") -> finalsize_dat

finalsize_dat
```

## Final size

```{r}
library(finalsize)

# Define population in each age group
scalar <- max(eigen(contact_data$matrix)$values)
contact_matrix <- apply(contact_data$matrix, 1, function(x) x/demography_vector)/scalar
# Define susceptibility of each group
susceptibility <- matrix(
  data = c(1.0, 1, 1),
  nrow = length(demography_vector),
  ncol = 1
)

# Assume uniform susceptibility within age groups
p_susceptibility <- matrix(
  data = 1.0,
  nrow = length(demography_vector),
  ncol = 1
)

# Calculate the proportion of individuals infected in each age group
final_size(
  r0 = pandemic_influenza$r0,
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  susceptibility = susceptibility,
  p_susceptibility = p_susceptibility
) |>
  dplyr::select(demo_grp, finalsize = p_infected) -> dat

finalsize_dat |>
  dplyr::select(demo_grp = demography_group, seir_v = value) |>
  dplyr::left_join(dat)
```

## Susceptibility

- Do we want to discuss susceptiblity structure?

## Vaccination

Final size does not allow us to implement a dynamic vaccination calendar, but if the vaccine is delivered before the main wave, then we the overall outcome is comparable. 

```{r}
# prepare a vaccination object
vaccinate_elders <- vaccination(
  name = "vaccinate elders",
  time_begin = matrix(1, nrow(contact_matrix)),
  time_end = matrix(150, nrow(contact_matrix)),
  nu = matrix(c(0.0, 0.0, 0.001))
)

output <- epidemic_default_cpp(
  population = uk_population,
  infection = pandemic_influenza,
  vaccination = vaccinate_elders,
  time_end = 600, increment = 1.0
)

# Calculate the attack rate using the fraction of recovered
output |>
  dplyr::filter(time == max(time)) |>
  dplyr::reframe(value = value/sum(value), compartment, .by = c("demography_group")) -> prop_dat
prop_dat |>
  dplyr::filter(compartment == "recovered") -> finalsize_dat

finalsize_dat
```

```{r}
# Proportion of the individuals vaccinated 
prop_dat |>
  dplyr::filter(compartment == "vaccinated") |>
  dplyr::pull(value) -> p_vacc

susceptibility <- matrix(
  data = 1,
  nrow = length(demography_vector),
  ncol = 2
)
# Second column holds the vaccinated (who are prettected fully)
susceptibility[,2] <- 0
# Assume uniform susceptibility within age groups
p_susceptibility <- matrix(
  data = 1.0,
  nrow = length(demography_vector),
  ncol = 2
)
p_susceptibility[,2] <- p_vacc
p_susceptibility[,1] <- 1 - p_vacc

# Calculate the proportion of individuals infected in each age group
final_size(
  r0 = pandemic_influenza$r0,
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  susceptibility = susceptibility,
  p_susceptibility = p_susceptibility
) -> dat1

# Final size returns the proportion infected in each susceptibility group (i.e. non vaccinated and vaccinated)
# here we calculate the proportion of infected for the age group as a whole
dat1 |>
  dplyr::select(-susceptibility) |>
  tidyr::pivot_wider(names_from = susc_grp, values_from = p_infected) -> dat3
fs <- rowSums(dat3[,2:3]*p_susceptibility)

finalsize_dat |>
  dplyr::select(demo_grp = demography_group, seir_v = value) |>
  dplyr::mutate(finalsize = fs)
```

