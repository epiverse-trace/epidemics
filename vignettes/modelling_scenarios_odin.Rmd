---
title: "Modelling intervention scenarios - odin"
output:
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
bibliography: references.json
link-citations: true
vignette: >
  %\VignetteIndexEntry{Modelling intervention scenarios - odin}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.height = 4,
  dpi = 150
)
```

Scenario modelling can guide epidemic response measures by helping to establish general principles around the potential effects of interventions. Here is an example of the main scenario modelling vignette with an odin backend

```{r setup}
# epi modelling
library(epidemics)

# data manipulation packages
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(colorspace)
library(ggdist)
library(odin)
library(data.table)

# for reproducibility
library(withr)
```

### Setting up the epidemic context

```{r class.source = 'fold-hide'}
# load contact and population data from socialmixr::polymod
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 65),
  symmetric = TRUE
)

# prepare contact matrix
contact_matrix <- t(contact_data$matrix)

# prepare the demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)

# initial conditions
initial_i <- 1e-4
initial_conditions <- c(
  S = 1 - initial_i, E = 0, I = initial_i, R = 0, V = 0
)

# build for all age groups
initial_conditions <- rbind(
  initial_conditions,
  initial_conditions,
  initial_conditions
)
# assign rownames for clarity
rownames(initial_conditions) <- rownames(contact_matrix)

# UK population created from hidden code
uk_population <- population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  initial_conditions = initial_conditions
)
```

### Creating a list of intervention sets

We shall create a list of 'intervention sets', each set representing a scenario of epidemic response measures.

**Note that** each intervention set is simply a list of `<intervention>` objects; typically, a single `<contacts_intervention>` and any `<rate_interventions>` on infection parameters.

```{r}
# create three distinct contact interventions
# prepare an intervention that models school closures for 180 days
close_schools <- intervention(
  name = "School closure",
  type = "contacts",
  time_begin = 60,
  time_end = 60 + 180,
  reduction = matrix(c(0.3, 0.01, 0.01)) #c()
)

# prepare an intervention which mostly affects adults 20 -- 65
close_workplaces <- intervention(
  name = "Workplace closure",
  type = "contacts",
  time_begin = 80,
  time_end = 140,
  reduction = matrix(c(0.01, 0.3, 0.01)) #c()
)

# prepare a combined intervention
combined_intervention <- c(close_schools, close_workplaces)

vaccinate_elders <- vaccination(
  name = "vaccinate elders",
  time_begin = matrix(400, nrow(contact_matrix)),
  time_end = matrix(500, nrow(contact_matrix)),
  nu = matrix(c(0, 0, 0.02)) # assume zero for now
)

vaccinate_young <- vaccination(
  name = "vaccinate young",
  time_begin = matrix(150, nrow(contact_matrix)),
  time_end = matrix(200, nrow(contact_matrix)),
  nu = matrix(c(0.05, 0, 0)) # assume zero for now
)

# prepare a combined intervention
combined_vaccination <- c(vaccinate_elders, vaccinate_young)


# NOT CURRENTLY USED:
# create a mask-mandate rate intervention
# prepare an intervention that models mask mandates for 300 days
# mask_mandate <- intervention(
#   name = "mask mandate",
#   type = "rate",
#   time_begin = time_begin,
#   time_end = time_end,
#   reduction = 0.1
# )

# create intervention sets, which are combinations of contacts and rate
# interventions
# scenario_07 = list(
#     contacts = combined_intervention,
#     transmission_rate = mask_mandate
# )
```


Now we define the odin model
```{r}
seirv_model <- odin::odin({
  # Time-dependent parameters
  # beta <- interpolate(beta_t, beta_y, "linear")
  # sigma <- interpolate(sigma_t, sigma_y, "linear")
  # gamma <- interpolate(gamma_t, gamma_y, "linear")

  # Contact matrix with time-dependent interventions
  # Then multiply across interventions - need to check this
  contact_reduction[,] <- if (t > intervention_start[i] && t < intervention_end[i]) (1.0 - intervention_effect[i,j]) else 1
  contact_reduction_log[,] <- log(contact_reduction[i,j] + 1e-10) # Avoid zero
  contact_reduction_total_log[] <- sum(contact_reduction_log[,i]) 
  contact_reduction_total[] <- exp(contact_reduction_total_log[i]) 
  
  # contact_reduction_total[,] <- sum(contact_reduction[1,i]) # DEBUG

  # Specify how transmission varies over time
  # FOI is contacts * infectious * transmission rate
  # returns a matrix, must be converted to a vector/1D array
  lambda_prod[, ] <- C[i, j] * I[j] * beta * contact_reduction_total[j] * contact_reduction_total[i]
  lambda[] <- sum(lambda_prod[i, ])

  # Vaccination - indexing over age groups
  vax_rate[] <- if (t >= vax_start[i] && t < vax_end[i]) vax_nu[i] else 0 

  # ODEs
  deriv(S[]) <- - (lambda[i] * S[i]) - (vax_rate[i] * S[i])
  deriv(E[]) <- lambda[i] * S[i] - sigma * E[i]
  deriv(I[]) <- sigma * E[i] - gamma * I[i]
  deriv(R[]) <- gamma * I[i]
  deriv(V[]) <- vax_rate[i] * S[i]

  # Initial conditions
  initial(S[]) <- init_S[i]
  initial(E[]) <- init_E[i]
  initial(I[]) <- init_I[i]
  initial(R[]) <- init_R[i]
  initial(V[]) <- init_V[i]

  # User-defined parameters
  C[, ] <- user()
  n_age <- user()
  n_intervention <- user()
  beta <- user()
  sigma <- user()
  gamma <- user()
  
  # Not currently used (can re-add for time-dependent parameters)
  # beta_t[] <- user()
  # beta_y[] <- user()
  # sigma_t[] <- user()
  # sigma_y[] <- user()
  # gamma_t[] <- user()
  # gamma_y[] <- user()
  intervention_start[] <- user()
  intervention_end[] <- user()
  intervention_effect[, ] <- user()
  vax_start[] <- user()
  vax_end[] <- user()
  vax_nu[] <- user()
  init_S[] <- user()
  init_E[] <- user()
  init_I[] <- user()
  init_R[] <- user()
  init_V[] <- user()

  # Dimensions
  dim(C) <- c(n_age, n_age)
  dim(lambda_prod) <- c(n_age, n_age)
  dim(lambda) <- n_age
  dim(S) <- n_age
  dim(E) <- n_age
  dim(I) <- n_age
  dim(R) <- n_age
  dim(V) <- n_age
  dim(contact_reduction) <- c(n_intervention, n_age)
  dim(contact_reduction_log) <- c(n_intervention, n_age)
  dim(contact_reduction_total_log) <- c(n_age)
  dim(contact_reduction_total) <- c(n_age)
  dim(intervention_start) <- n_intervention
  dim(intervention_end) <- n_intervention
  dim(intervention_effect) <- c(n_intervention, n_age)
  dim(vax_rate) <- n_age
  dim(vax_start) <- n_age
  dim(vax_end) <- n_age
  dim(vax_nu) <- n_age
  dim(init_S) <- n_age
  dim(init_E) <- n_age
  dim(init_I) <- n_age
  dim(init_R) <- n_age
  dim(init_V) <- n_age
})
```

Create an odin wrapper function
```{r}
model_default_odin <- function(population,
                               transmission_rate = 1.5 / 7.0,
                               infectiousness_rate = 1.0 / 3.0,
                               recovery_rate = 1.0 / 7.0,
                               intervention = NULL,
                               vaccination = NULL,
                               time_dependence = NULL,
                               time_end = 100,
                               increment = 1) {
  
  # Input validation (TO DO: take from model_default)
  # ... (add input validation code here)

  # Prepare model parameters
  # Scale initial conditions for odin model
  initial_conditions <- population$initial_conditions*demography_vector
  n_age <- nrow(population$contact_matrix)
  time_points <- seq(0, time_end, by = increment)
  
  # prepare contact matrix, divide by leading eigenvalue and rowwise by popsize
  contact_matrix_norm <- population$contact_matrix
  contact_matrix_norm <- (contact_matrix_norm / max(Re(eigen(contact_matrix_norm)$values))) /
  population$demography_vector


  # Apply time dependence if provided
    # beta_t <- sigma_t <- gamma_t <- time_points
  # beta_y <- rep(transmission_rate, length(time_points))
  # sigma_y <- rep(infectiousness_rate, length(time_points))
  # gamma_y <- rep(recovery_rate, length(time_points))
  # if (!is.null(time_dependence)) {
  #   if (!is.null(time_dependence$transmission_rate)) {
  #     beta_y <- sapply(time_points, function(t) time_dependence$transmission_rate(t, transmission_rate))
  #   }
  #   if (!is.null(time_dependence$infectiousness_rate)) {
  #     sigma_y <- sapply(time_points, function(t) time_dependence$infectiousness_rate(t, infectiousness_rate))
  #   }
  #   if (!is.null(time_dependence$recovery_rate)) {
  #     gamma_y <- sapply(time_points, function(t) time_dependence$recovery_rate(t, recovery_rate))
  #   }
  # }

  # Prepare intervention parameters
  # Add null intervention if needed as odin model requires matrix input
  intervention_start <- intervention_end <- 0
  intervention_effect <- rep(0, n_age)
  if (!is.null(intervention) & length(intervention$time_begin)>=2) {
    intervention_start <- as.numeric(intervention$time_begin)
    intervention_end <- as.numeric(intervention$time_end)
    intervention_effect <- t(intervention$reduction) # row is the intervention
  }
  # If zero or one intervention
  if (!is.null(intervention) | length(intervention$time_begin)<2) {
    null_intervention <- intervention(
      name = "Null closure",
      type = "contacts",
      time_begin = 1e5,
      time_end = 1e5+1,
      reduction = matrix(c(0,0,0)) #c()
    )
    intervention <- c(intervention,null_intervention,null_intervention)
    intervention_start <- as.numeric(intervention$time_begin)
    intervention_end <- as.numeric(intervention$time_end)
    intervention_effect <- t(intervention$reduction) # row is the intervention
  }

  n_intervention = length(intervention_start)

  # Prepare vaccination parameters
  vax_start <- vax_end <- rep(0, n_age)
  vax_nu <- rep(0, n_age)
  if (!is.null(vaccination)) {
    vax_start <- as.numeric(vaccination$time_begin)
    vax_end <- as.numeric(vaccination$time_end)
    vax_nu <- as.numeric(vaccination$nu)
  }

  # Initialize and run the model
  model <- seirv_model$new(
    C = contact_matrix_norm,
    n_age = n_age,
    n_intervention = n_intervention,
    beta = transmission_rate,
    sigma = infectiousness_rate,
    gamma = recovery_rate,
    intervention_start = intervention_start,
    intervention_end = intervention_end,
    intervention_effect = intervention_effect,
    vax_start = vax_start,
    vax_end = vax_end,
    vax_nu = vax_nu,
    init_S = initial_conditions[,1],
    init_E = initial_conditions[,2],
    init_I = initial_conditions[,3],
    init_R = initial_conditions[,4],
    init_V = initial_conditions[,5]
  )

  result <- model$run(time_points)
  
  # Add scenario information
  dt <- as.data.table(result)
  setnames(dt, "t", "time")

  # Melt the data table to long format
  long_dt <- melt(dt, id.vars = "time", 
                  variable.name = "temp", 
                  value.name = "value")
  
  # Split the 'temp' column into compartment and demography group
  long_dt[, c("compartment", "demography_group") := tstrsplit(temp, "\\[", keep = 1:2)]
  
  # Clean up the demography group
  long_dt[, demography_group := gsub("\\]", "", demography_group)]
  
  # Map compartment abbreviations to full names
  compartment_map <- c("S" = "susceptible", "E" = "exposed", "I" = "infectious", 
                       "R" = "recovered", "V" = "vaccinated")
  long_dt[, compartment := compartment_map[compartment]]
  
  # Map demography group numbers to age ranges
  demography_map <- c("1" = "[0,20)", "2" = "[20,40)", "3" = "40+")
  long_dt[, demography_group := demography_map[demography_group]]
  
  # Select and order columns
  formatted_output <- long_dt[, .(time, demography_group, compartment, value)]
  
  # Order the rows
  setorder(formatted_output, time, demography_group, compartment)
  
  # Set column classes
  formatted_output[, `:=`(
    time = as.numeric(time),
    demography_group = as.character(demography_group),
    compartment = as.character(compartment),
    value = as.numeric(value)
  )]

  # return data.table
  formatted_output[]
  
}
```

Run the model
```{r}
output_baseline <- model_default_odin(population=uk_population,
                              transmission_rate = 1.3 / 7.0,
                              infectiousness_rate = 1.0 / 2,
                              recovery_rate = 1.0 / 7.0,
                              time_dependence = NULL,
                              time_end = 600,
                              increment = 1)

data_baseline_infections <- new_infections(output_baseline, by_group = TRUE)

output <- model_default_odin(population=uk_population,
                              transmission_rate = 1.3 / 7.0,
                              infectiousness_rate = 1.0 / 2,
                              recovery_rate = 1.0 / 7.0,
                              intervention = combined_intervention,
                              vaccination = vaccinate_elders,
                              time_dependence = NULL,
                              time_end = 600,
                              increment = 1)

data_infections <- new_infections(output, by_group = TRUE, compartments_from_susceptible="vaccinated")
```

Plot the results

```{r}
#filter(output, compartment == "infectious") %>%
ggplot() +
    geom_vline(
    xintercept = c(
      close_schools$time_begin,
      close_schools$time_end
    ),
    linetype = "dotted"
  ) +
  geom_vline(
    xintercept = c(
      close_workplaces$time_begin,
      close_workplaces$time_end
    ),
    colour = "red",
    linetype = "dotted"
  ) +
  geom_vline(
    xintercept = c(
      vaccinate_elders$time_begin,
      vaccinate_elders$time_end
    ),
    colour = "blue",
    linetype = "dotted"
  ) +
  annotate(
    geom = "text",
    x = mean(c(close_schools$time_begin, close_schools$time_end)),
    y = 50000,
    label = "Schools closed"
  ) +
  annotate(
    geom = "text",
    x = mean(c(
      close_workplaces$time_begin,
      close_workplaces$time_end
    )),
    y = 30000,
    colour = "red",
    label = "Workplaces\nclosed"
  ) +
  annotate(
    geom = "text",
    x = mean(c(vaccinate_elders$time_begin, vaccinate_elders$time_end)),
    y = 50000,
    colour = "blue",
    label = "Vaccinate\nelderly"
  ) +
  geom_line(
    data = data_baseline_infections,
    aes(time, new_infections, colour = demography_group),
    linetype = "dashed"
  ) +
  geom_line(
    data = data_infections,
    aes(time, new_infections, colour = demography_group)
  ) +
  scale_colour_brewer(
    palette = "Dark2",
    labels = rownames(contact_matrix),
    name = "Age group"
  ) +
  scale_y_sqrt(
    labels = scales::comma,
    breaks = c(10^seq(3, 5), 5e4)
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  labs(
    x = "Model time (days)"
  ) +
  theme_bw() +
  theme(
    legend.position = "top"
  )
```
